# Downloading the photos to the mobile app

Our back end is now complete with APIs to upload and download photos. The mobile app can take a photo, check it for happy Xamarin developers and upload the photo to the back end.

The next step is to extend `IAzureService` to be able to download photos to the mobile device. Head back to your Xamarin mobile app, where you will need to add code to the Azure service to download all the photo metadata as well as downloading the individual photos.

## 1. Creating a data object for photo metadata

The Azure Function, `GetAllPhotosMetadata`, returns a collection of JSON objects with a load of fields; some that we want, some that we don't.

We will  create a simple C# data object in our mobile app that deserializes these JSON objects into the relevant fields.

| Property    | Type       | Description                                                        |
| ----------- | ---------- | ------------------------------------------------------------------ |
| `Name`      | `string`   | The name of the Blob that contains the actual photo                |
| `Caption`   | `string`   | The caption for the photo generated by the Computer Vision service |
| `Tags`      | `string[]` | The tags for the photo generated by the Computer Vision service    |
| `Timestamp` | `long`     | A timestamp for when the document was created                      |

1. In the Visual Studio Solution Explorer, right-click on the second-from-the-top **HappyXamDevs** option > **Add** > **New Folder**
    > **Warning:** Do not select **Add Solution Folder**. If you are given the option **Add Solution Folder**, you have right-clicked on top-most **HappyXamDevs** option.

2. In the Visual Studio Solution Explorer, name the new folder `Models`

3. In the Visual Studio Solution Explorer, right-click on the newly created **Models** folder > **Add** > **Class**

    - (Mac) On Visual Studio for Mac, right-click on the newly created **Models** folder > **Add** > **New File**

4. In the **Add New Item** window, name the file `PhotoMetadataModel.cs`

5. In the **PhotoMetadataModel.cs** editor, enter the following code:

```csharp
using System.IO;
using Newtonsoft.Json;
using Xamarin.Essentials;

namespace HappyXamDevs.Models
{
    public class PhotoMetadataModel
    {
        public string FileName => Path.Combine(FileSystem.CacheDirectory, $"{Name}.jpg");

        public string Caption { get; set; }

        public string Name { get; set; }

        public string[] Tags { get; set; }

        [JsonProperty("_ts")]
        public long Timestamp { get; set; }
    }
}
```

> **Note:** Every Cosmos DB document gets a timestamp field created automatically called `_ts`, and this contains the time the document was inserted or last updated using a UNIX timestamp (the number of elapsed seconds since January 1, 1970). We can tell `Newtonsoft.Json` to map the `_ts` field to the `Timestamp` property using the `JsonProperty` attribute on the property.

> **Note:** For a production quality app we should also think about how the app will work without an internet connection by caching the metadata and reducing network load. We should also consider connectivity and try not to download if the device is offline, something you can check using [Xamarin.Essentials.Connectivity](https://docs.microsoft.com/xamarin/essentials/connectivity/?WT.mc_id=mobileappsoftomorrow-workshop-jabenn). 

## 2. Downloading individual photos

For each photo metadata item that will be downloaded, our app will download the actual photos. This is a slow network call, so ideally the app should cache these photos locally to avoid having to re-download the files each time. The method to do this should check if the file exists using the Blob name as the file name, and if it doesn't exist, download the image.

1. In the Visual Studio Solution Explorer, open **HappyXamDevs** > **Services** > **IAzureService.cs**

2. In the **IAzureService.cs** editor, enter the following code:

```csharp
using System.Collections.Generic;
using System.Threading.Tasks;
using HappyXamDevs.Models;
using Plugin.Media.Abstractions;

namespace HappyXamDevs.Services
{
    public interface IAzureService
    {
        Task DownloadPhoto(PhotoMetadataModel photoMetadata);

        Task<IEnumerable<PhotoMetadataModel>> GetAllPhotoMetadata();

        Task UploadPhoto(MediaFile photo);

        Task<bool> VerifyHappyFace(MediaFile photo);
    }
}
```

3. In the Visual Studio Solution Explorer, open **HappyXamDevs** > **Services** > **AzureService.cs**

4. In the **AzureService.cs** editor, enter the following using statements:

```csharp
using System.IO;
using System.Net.Http;
using Xamarin.Essentials;
using HappyXamDevs.Models;
```

5. In the **AzureService.cs** editor, enter the following method:

```csharp
public async Task DownloadPhoto(PhotoMetadataModel photoMetadata)
{
    if (File.Exists(photoMetadata.FileName))
        return;

    var result = await Client.InvokeApiAsync($"photo/{photoMetadata.Name}", HttpMethod.Get, new Dictionary<string, string>());

    var photo = result["photo"].Value<string>();
    var bytes = Convert.FromBase64String(photo);

    using (var fs = new FileStream(photoMetadata.FileName, FileMode.CreateNew))
        await fs.WriteAsync(bytes, 0, bytes.Length);
}
```

> **About the Code**
>
> `if (File.Exists(photoMetadata.FileName))` first checks to see if a file exits; if it does we won't try to re-downlaod it
>
> `await Client.InvokeApiAsync($"photo/{photoMetadata.Name}", HttpMethod.Get, new Dictionary<string, string>());` downloads the photo from the Azure Function `GetPhoto`
>
> `var photo = result["Photo"].Value<string>();` retrieves the photo as a Base64 string from the JSON response
>
> `var bytes = Convert.FromBase64String(photo);` converts the Base64 string into a `Byte[]` so that it can be saved to the file system
>
> `await fs.WriteAsync(bytes, 0, bytes.Length);` saves the photo to the file system on our mobile device

## 3. Downloading the photo metadata

1. In the **AzureService.cs** editor, add the following method:

```csharp
public async Task<IEnumerable<PhotoMetadataModel>> GetAllPhotoMetadata()
{
    var allMetadata = await Client.InvokeApiAsync<List<PhotoMetadataModel>>(PhotoResource, HttpMethod.Get, new Dictionary<string, string>());

    foreach (var metadata in allMetadata)
        await DownloadPhoto(metadata);

    return allMetadata;
}
```

> **About the Code**
>
> `await Client.InvokeApiAsync<List<PhotoMetadataModel>>(PhotoResource, HttpMethod.Get, new Dictionary<string, string>());` retrieves the photo metada from the Azure Function, `GetAllPhotoMetata`

## Next step

Now that you have photos downloaded, the next step is to [show these photos on the UI](./11-ShowPhotosOnMobileApp.md).
